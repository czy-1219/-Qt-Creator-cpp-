# 打车系统工程逻辑与原理

## 1. 工程概述

本工程是一个基于Qt框架开发的打车/网约车系统，包含乘客端、司机端和平台监控端三个主要模块。系统实现了完整的打车流程，包括乘客叫车、订单创建、司机接单、行程监控和订单完成等功能。

### 1.1 核心功能

- **乘客端**：地图交互、叫车请求、订单跟踪、取消订单
- **司机端**：离线/在线切换、订单接收/拒绝、行程管理、路线规划
- **平台端**：订单监控、司机管理、统计分析、实时地图

## 2. 系统架构

### 2.1 分层设计

本系统采用经典的MVC（模型-视图-控制器）架构设计：

| 层级 | 职责 | 主要文件 |
|------|------|----------|
| **视图层** | UI界面展示与用户交互 | mainwindow.h/cpp, passengerwindow.h/cpp, driverwindow.h/cpp, platformwindow.h/cpp |
| **控制层** | 业务逻辑处理 | ordermanager.h/cpp, dispatchsystem.h/cpp, pathplanner.h/cpp |
| **模型层** | 数据存储与管理 | driver.h/cpp, passenger.h/cpp, order.h/cpp, mapdata.h/cpp |
| **工具层** | 辅助功能支持 | workerthread.h/cpp, user.h/cpp |

### 2.2 设计模式

- **单例模式**：OrderManager, DispatchSystem, PathPlanner, MapData均采用单例设计，确保全局唯一实例
- **观察者模式**：Qt信号槽机制实现组件间通信
- **策略模式**：不同打车类型（快车、专车）的计价策略
- **命令模式**：订单创建、取消等操作封装为命令

## 3. 核心模块分析

### 3.1 乘客模块

**功能**：处理乘客叫车请求，管理订单状态

**主要流程**：
1. 乘客在地图上选择起点和终点
2. 选择打车类型（快车/专车）
3. 系统计算预估费用和时间
4. 乘客确认叫车
5. 系统创建订单并分配司机
6. 乘客跟踪订单状态

**关键类**：
- `Passenger`：乘客信息管理
- `PassengerWindow`：乘客UI界面
- `Order`：订单信息管理

### 3.2 司机模块

**功能**：管理司机状态，处理订单分配

**主要流程**：
1. 司机切换在线/离线状态
2. 系统分配订单
3. 司机接收/拒绝订单
4. 司机前往乘客起点
5. 开始行程
6. 结束行程

**关键类**：
- `Driver`：司机信息管理
- `DriverWindow`：司机UI界面
- `DispatchSystem`：订单分配逻辑

### 3.3 订单管理模块

**功能**：处理订单生命周期

**主要流程**：
1. 创建订单
2. 分配司机
3. 更新订单状态
4. 完成订单
5. 计算费用

**关键类**：
- `OrderManager`：订单生命周期管理
- `Order`：订单数据模型

### 3.4 派单模块

**功能**：基于算法分配最优司机

**主要流程**：
1. 接收新订单
2. 筛选在线空闲司机
3. 计算司机与乘客距离
4. 排序并分配最优司机
5. 处理司机拒绝情况

**关键类**：
- `DispatchSystem`：派单核心逻辑
- `MapData`：地图数据管理
- `PathPlanner`：路径规划

### 3.5 地图模块

**功能**：提供地图数据和路径规划

**主要流程**：
1. 生成网格地图
2. 计算两点间距离
3. 规划最优路径
4. 平滑路径

**关键类**：
- `MapData`：地图数据管理
- `PathPlanner`：路径规划算法

## 4. Qt库的运用

### 4.1 Qt核心框架

- **QApplication**：应用程序入口，管理事件循环
- **QMainWindow**：主窗口基类，包含菜单栏、工具栏和状态栏
- **QWidget**：所有UI组件的基类
- **QGraphicsScene/View**：地图绘制和交互

### 4.2 UI组件

| 组件类型 | 用途 | 示例 |
|----------|------|------|
| 按钮 | 触发操作 | QPushButton |
| 输入框 | 文本输入 | QLineEdit |
| 列表 | 显示数据 | QListWidget |
| 组合框 | 选择选项 | QComboBox |
| 进度条 | 显示进度 | QProgressBar |
| 标签 | 显示文本 | QLabel |

### 4.3 信号槽机制

Qt的信号槽机制是实现组件间通信的核心，无需直接调用，通过信号和槽的连接实现松耦合通信。

**示例**：
```cpp
// 连接按钮点击事件
connect(ui->requestRideBtn, &QPushButton::clicked, this, &PassengerWindow::on_requestRideBtn_clicked);

// 连接订单状态变化信号
connect(OrderManager::instance(), &OrderManager::orderstatuschanged, this, &PassengerWindow::on_orderstatuschanged);
```

### 4.4 事件处理

系统通过事件过滤器实现地图交互：

```cpp
bool PassengerWindow::eventFilter(QObject *obj, QEvent *event)
{
    if (obj == ui->mapView->viewport() && event->type() == QEvent::MouseButtonPress) {
        // 处理地图点击事件
        QMouseEvent *mouseEvent = static_cast<QMouseEvent*>(event);
        // ...
    }
    return QMainWindow::eventFilter(obj, event);
}
```

## 5. 后端与前端UI链接原理

### 5.1 数据流向

后端数据通过信号槽机制流向前端UI，实现实时更新：

1. **后端数据变化** → 2. **发出信号** → 3. **信号槽连接** → 4. **前端UI更新**

### 5.2 关键连接点

| 后端模块 | 信号 | 前端模块 | 槽函数 | 作用 |
|----------|------|----------|--------|------|
| OrderManager | orderstatuschanged | PassengerWindow | on_orderstatuschanged | 更新订单状态 |
| OrderManager | orderstatuschanged | DriverWindow | onorderstatuschanged | 更新订单状态 |
| DispatchSystem | driverassigned | DriverWindow | onorderassigned | 通知司机新订单 |
| DispatchSystem | availableordersupdated | DriverWindow | onavailableordersupdated | 更新可用订单 |
| Driver | locationUpdated | PassengerWindow | updatedriverlocation | 更新司机位置 |

### 5.3 实时更新机制

系统采用定时器实现实时数据更新：

```cpp
// 设置定时器，每秒更新一次司机位置
m_updateTimer = new QTimer(this);
m_updateTimer->start(1000);
connect(m_updateTimer, &QTimer::timeout, this, &PassengerWindow::updatedriverposition);
```

## 6. 核心接口详细说明

### 6.1 司机模块接口

#### Driver类

**核心功能**：管理司机信息、状态和订单处理

| 接口方法 | 功能描述 | 参数说明 | 返回值 |
|----------|----------|----------|--------|
| `licenseplate()` | 获取车牌号 | 无 | `QString` |
| `setlicenseplate(const QString &licenseplate)` | 设置车牌号 | licenseplate: 车牌号 | 无 |
| `carmodel()` | 获取车型 | 无 | `QString` |
| `setcarmodel(const QString &carmodel)` | 设置车型 | carmodel: 车型 | 无 |
| `currentlocation()` | 获取当前位置 | 无 | `QPair<int, int>` |
| `setcurrentlocation(int x, int y)` | 设置当前位置 | x, y: 坐标 | 无 |
| `isonline()` | 获取在线状态 | 无 | `bool` |
| `setonline(bool online)` | 设置在线状态 | online: 在线状态 | 无 |
| `acceptorder(Order *order)` | 接受订单 | order: 订单对象 | 无 |
| `rejectorder(Order *order)` | 拒绝订单 | order: 订单对象 | 无 |
| `starttrip(Order *order)` | 开始行程 | order: 订单对象 | 无 |
| `endtrip(Order *order)` | 结束行程 | order: 订单对象 | 无 |
| `completedorders()` | 获取完成订单数 | 无 | `int` |
| `incrementcompletedorders()` | 增加完成订单数 | 无 | 无 |
| `hasactiveorder()` | 是否有活跃订单 | 无 | `bool` |
| `currentorder()` | 获取当前订单 | 无 | `Order *` |
| `setactiveorder(Order *order)` | 设置当前订单 | order: 订单对象 | 无 |
| `clearactiveorder()` | 清除当前订单 | 无 | 无 |
| `totalmileage()` | 获取累计里程 | 无 | `double` |
| `addmileage(double mileage)` | 增加里程 | mileage: 增加的里程 | 无 |

**信号**：
- `orderaccepted(Order *order)`: 司机接受订单时触发
- `orderrejected(Order *order)`: 司机拒绝订单时触发
- `tripstarted(Order *order)`: 行程开始时触发
- `tripended(Order *order)`: 行程结束时触发
- `locationupdated(int x, int y)`: 位置更新时触发
- `onlinestatuschanged(bool online)`: 在线状态改变时触发

### 6.2 乘客模块接口

#### Passenger类

**核心功能**：管理乘客信息和叫车请求

| 接口方法 | 功能描述 | 参数说明 | 返回值 |
|----------|----------|----------|--------|
| `favoriteaddresses()` | 获取常用地址列表 | 无 | `QList<QPair<QString, QPair<double, double>>>` |
| `addfavoriteaddress(const QString &name, double lat, double lon)` | 添加常用地址 | name: 地址名称, lat/lon: 坐标 | 无 |
| `historyorders()` | 获取历史订单 | 无 | `QList<Order*>` |
| `addhistoryorder(Order *order)` | 添加历史订单 | order: 订单对象 | 无 |
| `requestride(int startX, int startY, int endX, int endY, const QString &carType)` | 发起叫车请求 | 起止坐标和车型 | 无 |
| `cancelorder(Order *order)` | 取消订单 | order: 订单对象 | 无 |
| `queryorderstatus(Order *order)` | 查询订单状态 | order: 订单对象 | 无 |

**信号**：
- `riderequested(int startX, int startY, int endX, int endY, const QString &carType)`: 发起叫车请求时触发
- `ordercancelled(Order *order)`: 取消订单时触发

### 6.3 订单模块接口

#### Order类

**核心功能**：订单数据模型和状态管理

**订单状态枚举**：
- `Pending`: 待派单
- `Accepted`: 已接单
- `OnTheWay`: 司机前往接驾
- `PickingUp`: 正在接驾
- `InProgress`: 行程中
- `Completed`: 已完成
- `Cancelled`: 已取消

| 接口方法 | 功能描述 | 参数说明 | 返回值 |
|----------|----------|----------|--------|
| `id()` | 获取订单ID | 无 | `QString` |
| `passenger()` | 获取乘客对象 | 无 | `Passenger *` |
| `driver()` | 获取司机对象 | 无 | `Driver *` |
| `startlocation()` | 获取起点 | 无 | `QPair<int, int>` |
| `endlocation()` | 获取终点 | 无 | `QPair<int, int>` |
| `cartype()` | 获取车型 | 无 | `QString` |
| `status()` | 获取订单状态 | 无 | `Status` |
| `setstatus(Status status)` | 设置订单状态 | status: 新状态 | 无 |
| `estimateddistance()` | 获取预估距离 | 无 | `double` |
| `estimatedtime()` | 获取预估时间 | 无 | `double` |
| `estimatedcost()` | 获取预估费用 | 无 | `double` |
| `actualcost()` | 获取实际费用 | 无 | `double` |
| `driverincome()` | 获取司机收入 | 无 | `double` |
| `createdat()` | 获取创建时间 | 无 | `QDateTime` |
| `acceptedat()` | 获取接单时间 | 无 | `QDateTime` |
| `completedat()` | 获取完成时间 | 无 | `QDateTime` |

**信号**：
- `statuschanged(Status oldStatus, Status newStatus)`: 订单状态变化时触发
- `driverassigned(Driver *driver)`: 分配司机时触发

#### OrderManager类

**核心功能**：订单生命周期管理（单例模式）

| 接口方法 | 功能描述 | 参数说明 | 返回值 |
|----------|----------|----------|--------|
| `createorder(Passenger *passenger, int startX, int startY, int endX, int endY, const QString &cartype)` | 创建订单 | 乘客对象、起止坐标、车型 | `Order *` |
| `findorderbyid(const QString &id)` | 根据ID查找订单 | id: 订单ID | `Order *` |
| `ordersbystatus(Order::Status status)` | 根据状态查找订单 | status: 订单状态 | `QList<Order *>` |
| `ordersbypassenger(Passenger *passenger)` | 根据乘客查找订单 | passenger: 乘客对象 | `QList<Order *>` |
| `ordersbydriver(Driver *driver)` | 根据司机查找订单 | driver: 司机对象 | `QList<Order *>` |
| `addorder(Order *order)` | 添加订单 | order: 订单对象 | 无 |
| `updateorderstatus(Order *order, Order::Status status)` | 更新订单状态 | order: 订单对象, status: 新状态 | 无 |
| `assigndrivertorder(Order *order, Driver *driver)` | 分配司机给订单 | order: 订单对象, driver: 司机对象 | 无 |
| `cancelorder(Order *order)` | 取消订单 | order: 订单对象 | 无 |
| `completeorder(Order *order)` | 完成订单 | order: 订单对象 | 无 |

**信号**：
- `ordercreated(Order *order)`: 创建订单时触发
- `orderstatuschanged(Order *order, Order::Status oldStatus, Order::Status newStatus)`: 订单状态变化时触发
- `orderassigned(Order *order, Driver *driver)`: 分配司机时触发
- `ordercancelled(Order *order)`: 取消订单时触发
- `ordercompleted(Order *order)`: 完成订单时触发

### 6.4 派单模块接口

#### DispatchSystem类

**核心功能**：订单分配逻辑（单例模式）

| 接口方法 | 功能描述 | 参数说明 | 返回值 |
|----------|----------|----------|--------|
| `registerdriver(Driver *driver)` | 注册司机 | driver: 司机对象 | 无 |
| `unregisterdriver(Driver *driver)` | 注销司机 | driver: 司机对象 | 无 |
| `onlinedrivers()` | 获取在线司机列表 | 无 | `QList<Driver *>` |
| `availableorders()` | 获取待派单订单列表 | 无 | `QList<Order *>` |
| `dispatchorder(Order *order)` | 派单 | order: 订单对象 | 无 |
| `assignordertodriver(Order *order, Driver *driver)` | 分配订单给司机 | order: 订单对象, driver: 司机对象 | 无 |
| `handledriverreject(Order *order, Driver *driver)` | 处理司机拒绝订单 | order: 订单对象, driver: 司机对象 | 无 |
| `calculatedistancetopassenger(Driver *driver, Order *order)` | 计算司机到乘客起点的距离 | driver: 司机对象, order: 订单对象 | `double` |

**信号**：
- `driverassigned(Order *order, Driver *driver)`: 分配司机时触发
- `nodriveravailable(Order *order)`: 无可用司机时触发
- `availableordersupdated()`: 可用订单列表更新时触发
- `orderacceptedbyother(Order *order)`: 订单被其他司机接受时触发

## 7. 模块间交互接口

### 7.1 主要交互流程

#### 乘客叫车流程接口调用链

1. `Passenger::requestride()` → 发出 `riderequested` 信号
2. `OrderManager::createorder()` → 创建订单
3. 发出 `ordercreated` 信号
4. `DispatchSystem::dispatchorder()` → 开始派单
5. `DispatchSystem::calculatedistancetopassenger()` → 计算司机距离
6. `DispatchSystem::assignordertodriver()` → 分配司机
7. 发出 `driverassigned` 信号
8. `Driver::acceptorder()` → 司机接受订单
9. 发出 `orderaccepted` 信号
10. `OrderManager::updateorderstatus()` → 更新订单状态
11. 发出 `orderstatuschanged` 信号
12. 前端UI更新订单状态

#### 司机接单流程接口调用链

1. `Driver::setonline(true)` → 设置在线状态
2. 发出 `onlinestatuschanged` 信号
3. `DispatchSystem::ondriveronlinestatuschanged()` → 处理司机上线
4. `OrderManager::ordersbystatus(Order::Pending)` → 获取待派单订单
5. `DispatchSystem::dispatchorder()` → 派单
6. `Driver::acceptorder()` → 接受订单
7. 发出 `orderaccepted` 信号
8. `OrderManager::assigndrivertorder()` → 分配司机给订单
9. `OrderManager::updateorderstatus()` → 更新订单状态
10. 发出 `orderstatuschanged` 信号

### 7.2 信号槽连接关系

| 发送方 | 信号 | 接收方 | 槽函数 | 作用 |
|--------|------|--------|--------|------|
| Passenger | riderequested | OrderManager | （间接调用）createorder | 创建订单 |
| OrderManager | ordercreated | DispatchSystem | （间接调用）dispatchorder | 开始派单 |
| DispatchSystem | driverassigned | Driver | （间接调用）acceptorder | 通知司机新订单 |
| Driver | orderaccepted | OrderManager | updateorderstatus | 更新订单状态为已接单 |
| Driver | tripstarted | OrderManager | updateorderstatus | 更新订单状态为行程中 |
| Driver | tripended | OrderManager | updateorderstatus | 更新订单状态为已完成 |
| OrderManager | orderstatuschanged | PassengerWindow | on_orderstatuschanged | 更新乘客端订单状态 |
| OrderManager | orderstatuschanged | DriverWindow | onorderstatuschanged | 更新司机端订单状态 |
| Driver | locationupdated | PassengerWindow | updatedriverlocation | 更新司机位置 |

## 8. 关键技术点

### 8.1 地图交互与绘制

- **网格地图**：系统使用简化的网格地图，每个网格单元代表实际距离
- **地图绘制**：使用QGraphicsScene和QGraphicsView实现地图绘制
- **坐标转换**：实现屏幕坐标与网格坐标的相互转换

### 6.2 路径规划算法

- **曼哈顿距离**：用于计算两点间最短路径
- **路径平滑**：优化路径，移除冗余点
- **实时路径更新**：根据司机位置实时更新行驶路径

### 6.3 多线程处理

- **后台线程**：使用WorkerThread处理耗时操作，如路径规划和订单分配
- **线程同步**：确保数据安全，避免竞态条件

### 6.4 数据持久化

- **用户数据**：保存乘客和司机信息
- **订单历史**：记录订单历史数据
- **地图数据**：生成和保存地图数据

## 7. 系统工作流程

### 7.1 乘客叫车流程

1. 乘客在地图上选择起点和终点
2. 系统计算预估费用和时间
3. 乘客确认叫车
4. OrderManager创建订单
5. DispatchSystem分配司机
6. 司机接收订单
7. 司机前往乘客起点
8. 开始行程
9. 行程中实时更新位置
10. 到达终点，结束行程
11. 计算费用，完成订单

### 7.2 司机接单流程

1. 司机切换在线状态
2. 系统分配订单
3. 司机接收/拒绝订单
4. 接收订单：前往乘客起点
5. 到达起点：开始行程
6. 到达终点：结束行程
7. 计算收入，更新累计里程

## 8. 系统扩展点

### 8.1 功能扩展

- 支持更多打车类型（顺风车、出租车）
- 实现支付功能
- 增加评分系统
- 支持多语言

### 8.2 性能优化

- 优化路径规划算法
- 实现负载均衡
- 增加缓存机制
- 优化数据库查询

## 9. 总结

本打车系统基于Qt框架开发，采用分层设计和多种设计模式，实现了完整的打车流程。系统通过信号槽机制实现了后端与前端UI的高效通信，支持实时数据更新和地图交互。

系统的核心优势在于：

1. **模块化设计**：各功能模块独立，便于维护和扩展
2. **实时性**：通过定时器和信号槽实现实时数据更新
3. **可扩展性**：预留了多种扩展接口
4. **用户友好**：直观的地图交互和简洁的UI设计

该系统可以作为打车/网约车平台的基础框架，进一步扩展和优化后可用于实际生产环境。